name: Publish package to the Maven Central Repository
on:
    pull_request:
        branches: [ main-spring-3 ]

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
            
            -   name: Set up Maven Central Repository
                uses: actions/setup-java@v4
                with:
                    java-version: 17
                    distribution: 'temurin'
                    server-id: ossrh
                    server-username: MAVEN_USERNAME
                    server-password: MAVEN_PASSWORD
                    gpg-passphrase: MAVEN_GPG_PASSPHRASE
            
            -   name: Configure Git
                run: |
                    git config --global user.name "github-actions[bot]"
                    git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
            -   name: Bump patch version
                run: |
                    chmod +x ./update-patch-version.sh
                    # Run the script (now fully automated)
                    ./update-patch-version.sh
            
            -   id: install-secret-key
                name: Install gpg secret key
                run: |
                    cat <(echo -e "${{ secrets.GPG_SIGNING_KEY }}") | gpg --batch --import
                    gpg --list-secret-keys --keyid-format LONG
            
            -   id: publish-to-central
                name: Publish to Central Repository
                env:
                    MAVEN_USERNAME: ${{ secrets.OSSRH_TOKEN_USERNAME }}
                    MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN_PASSWORD }}
                    MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSWORD }}
                run: |
                    echo "released"
            
            -   name: Commit and push version changes
                if: success()
                run: |
                    # Get the new version from pom.xml
                    NEW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
                    # Commit and push changes
                    git add .
                    git commit -m "Bump version to $NEW_VERSION"
                    # Create and push tag
                    git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
                    # Push both branch changes and tag
                    git push origin release-spring-3-tmp
                    git push origin "v$NEW_VERSION"
                    echo "âœ… Successfully committed and pushed version $NEW_VERSION with tag v$NEW_VERSION"
